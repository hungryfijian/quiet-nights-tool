<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Evidence-based sleep therapy tool for tinnitus management by Tinnitus Centres">
    <title>QuietNights - Sleep & Tinnitus Tool | Tinnitus Centres</title>
    
    <style>
        :root {
            --primary: #0ea9c7;
            --secondary: #0a4c7c;
            --accent: #662d91;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #f44336;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --white: #ffffff;
            --background: #c6dee7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0ea9c7 0%, #0a4c7c 100%);
            min-height: 100vh;
            color: var(--dark);
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0ea9c7 0%, #0a4c7c 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-screen h1 {
            color: white;
            margin-bottom: 20px;
            font-size: 2.5em;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .container.loaded {
            opacity: 1;
        }

        header {
            background: rgba(255,255,255,0.98);
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .session-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .session-timer {
            color: var(--secondary);
            font-weight: 500;
        }

        /* Main Layout Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Card Styles */
        .card {
            background: rgba(255,255,255,0.98);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .card-title {
            color: var(--secondary);
            font-size: 1.3em;
            margin-bottom: 20px;
            font-weight: 600;
        }

        /* Sound Control Panel */
        .sound-panel {
            grid-column: 1;
        }

        .master-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            align-items: stretch;
        }

        .play-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 2em;
            box-shadow: 0 4px 15px rgba(14,169,199,0.3);
            flex-shrink: 0;
        }

        .play-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(14,169,199,0.4);
        }

        .play-btn:active {
            transform: scale(0.98);
        }

        .play-btn.playing {
            background: linear-gradient(135deg, var(--accent), var(--secondary));
        }

        /* Enhanced Master Volume for Mobile */
        .master-volume-enhanced {
            flex: 1;
            background: var(--light);
            padding: 20px;
            border-radius: 12px;
        }

        .volume-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .volume-value-badge {
            background: var(--primary);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 18px;
            min-width: 70px;
            text-align: center;
        }

        .volume-control-wrapper {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .enhanced-slider {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            -webkit-appearance: none;
        }

        .enhanced-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .enhanced-slider::-moz-range-thumb {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .volume-step-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-weight: bold;
        }

        .volume-step-btn:hover {
            background: var(--secondary);
            transform: scale(1.1);
        }

        .volume-step-btn:active {
            transform: scale(0.95);
        }

        .volume-quick-presets {
            display: flex;
            gap: 8px;
            justify-content: space-between;
        }

        .volume-preset {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--primary);
            background: white;
            color: var(--primary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            font-size: 14px;
        }

        .volume-preset:hover {
            background: var(--primary);
            color: white;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: none;
        }

        .presets {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 30px;
        }

        .preset-btn {
            padding: 12px;
            border: 2px solid var(--primary);
            background: white;
            color: var(--primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .preset-btn:hover {
            background: var(--background);
            transform: translateY(-2px);
        }

        .preset-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Sound Layers */
        .sound-layers {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        @media (max-width: 768px) {
            .sound-layers {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .layer-control {
            background: linear-gradient(135deg, #f8f9ff 0%, #e6f7ff 100%);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(14,169,199,0.2);
            transition: all 0.3s ease;
        }

        .layer-control:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .layer-control.muted {
            opacity: 0.5;
            background: #f0f0f0;
        }

        .layer-name {
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .layer-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        .layer-volume-control {
            margin: 20px 0;
        }

        .volume-display {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 10px;
            min-width: 60px;
        }

        .layer-toggle {
            width: 100%;
            padding: 8px;
            margin-top: 10px;
            border: 2px solid var(--primary);
            background: white;
            color: var(--primary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .layer-toggle:hover {
            background: var(--primary);
            color: white;
        }

        .layer-toggle.muted {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        /* Timer Section */
        .timer-section {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #fff8f0 0%, #ffe6e6 100%);
            border-radius: 12px;
            border: 1px solid rgba(255,152,0,0.2);
        }

        .timer-options {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .timer-btn {
            padding: 10px;
            border: 2px solid var(--warning);
            background: white;
            color: var(--warning);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .timer-btn:hover {
            background: #fff3e0;
        }

        .timer-btn.active {
            background: var(--warning);
            color: white;
        }

        .timer-display {
            text-align: center;
            font-size: 2.5em;
            color: var(--secondary);
            font-weight: bold;
            padding: 20px;
            background: white;
            border-radius: 10px;
        }

        /* Techniques Panel */
        .techniques-panel {
            grid-column: 2;
        }

        .technique-card {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(102,45,145,0.2);
        }

        .technique-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(102,45,145,0.2);
        }

        .technique-title {
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 5px;
        }

        .technique-duration {
            color: #666;
            font-size: 0.9em;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: var(--secondary);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid var(--light);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(14,169,199,0.3);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Success Message */
        .success-message {
            display: none;
            background: var(--success);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-top: 20px;
        }

        .success-message.show {
            display: block;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Visualizer */
        .visualizer {
            height: 80px;
            background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%);
            border-radius: 10px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            padding: 10px;
        }

        .visualizer-bar {
            width: 3px;
            background: linear-gradient(to top, var(--primary), var(--accent));
            border-radius: 2px;
            transition: height 0.2s ease;
            min-height: 5px;
        }

        /* Email Modal Styles */
        .email-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .email-modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .secondary-btn {
            flex: 1;
            padding: 15px;
            background: #666;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .enhanced-slider {
                height: 10px;
            }
            
            .enhanced-slider::-webkit-slider-thumb,
            .enhanced-slider::-moz-range-thumb {
                width: 40px;
                height: 40px;
            }
            
            .volume-step-btn {
                width: 48px;
                height: 48px;
                font-size: 28px;
            }
            
            .master-volume-enhanced {
                padding: 15px;
            }
            
            .volume-quick-presets {
                margin-top: 12px;
            }

            .presets {
                grid-template-columns: repeat(2, 1fr);
            }

            .timer-options {
                grid-template-columns: repeat(3, 1fr);
            }

            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .main-grid {
                display: flex;
                flex-direction: column;
            }

            .sound-layers {
                grid-template-columns: 1fr;
            }
        }

        /* Error Message */
        .error-message {
            background: #fee;
            color: var(--danger);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid var(--danger);
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Audio Source Info */
        .audio-source-info {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.9em;
            color: #666;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <img src="https://image.jimcdn.com/app/cms/image/transf/none/path/s960b7fc6030ac054/image/ia85c92eb1d04ab76/version/1648189187/image.png" 
             alt="Tinnitus Centres Logo" 
             style="width: 150px; margin-bottom: 20px;">
        <h1>QuietNights</h1>
        <div class="loader"></div>
        <p style="color: white; margin-top: 20px;">Preparing your sleep therapy session...</p>
    </div>

    <!-- Main Container -->
    <div class="container" id="mainContainer">
        <!-- Header -->
        <header>
            <div class="header-content">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <img src="https://image.jimcdn.com/app/cms/image/transf/none/path/s960b7fc6030ac054/image/ia85c92eb1d04ab76/version/1648189187/image.png" 
                         alt="Tinnitus Centres" 
                         style="height: 40px;">
                    <div class="logo">QuietNights</div>
                </div>
                <div class="session-info">
                    <span class="session-timer">Session: <span id="sessionTime">00:00</span></span>
                    <span style="color: var(--primary);">Evidence-Based Sleep Therapy</span>
                </div>
            </div>
        </header>

        <!-- Error Message -->
        <div class="error-message" id="errorMessage"></div>

        <!-- Main Grid Layout -->
        <div class="main-grid">
            <!-- Center Panel: Sound Controls -->
            <div class="sound-panel">
                <div class="card">
                    <h2 class="card-title">🎵 Sound Therapy Console</h2>
                    
                    <!-- Enhanced Master Controls -->
                    <div class="master-controls">
                        <button class="play-btn" id="playBtn" onclick="togglePlayback()">
                            <span id="playIcon">▶</span>
                        </button>
                        <div class="master-volume-enhanced">
                            <div class="volume-header">
                                <span style="font-weight: 600; color: var(--secondary);">Master Volume</span>
                                <span id="masterVolumeValue" class="volume-value-badge">70%</span>
                            </div>
                            <div class="volume-control-wrapper">
                                <button class="volume-step-btn" onclick="adjustMasterVolume(-10)">−</button>
                                <input type="range" id="masterVolume" min="0" max="100" value="70" 
                                       class="enhanced-slider">
                                <button class="volume-step-btn" onclick="adjustMasterVolume(10)">+</button>
                            </div>
                            <div class="volume-quick-presets">
                                <button class="volume-preset" onclick="setMasterVolumePreset(25)">25%</button>
                                <button class="volume-preset" onclick="setMasterVolumePreset(50)">50%</button>
                                <button class="volume-preset" onclick="setMasterVolumePreset(75)">75%</button>
                                <button class="volume-preset" onclick="setMasterVolumePreset(100)">100%</button>
                            </div>
                        </div>
                    </div>

                    <!-- Visualizer -->
                    <div class="visualizer" id="visualizer"></div>

                    <!-- Presets -->
                    <div class="presets">
                        <button class="preset-btn" onclick="loadPreset('gentle')">Gentle Night</button>
                        <button class="preset-btn" onclick="loadPreset('deep')">Deep Sleep</button>
                        <button class="preset-btn" onclick="loadPreset('active')">Active Mind</button>
                        <button class="preset-btn" onclick="loadPreset('custom')">Custom Mix</button>
                    </div>

                    <!-- Sound Layers -->
                    <div class="sound-layers">
                        <!-- Foundation Layer -->
                        <div class="layer-control" data-layer="foundation">
                            <div class="layer-icon">🌊</div>
                            <div class="layer-name">Pink Noise</div>
                            <div class="layer-volume-control">
                                <input type="range" class="layer-volume-slider" 
                                       id="foundationVolume" min="0" max="100" value="70">
                                <div class="volume-display" id="foundationLabel">70%</div>
                            </div>
                            <button class="layer-toggle" onclick="toggleLayer('foundation')">Mute</button>
                        </div>

                        <!-- Nature Layer -->
                        <div class="layer-control" data-layer="nature">
                            <div class="layer-icon">🌧️</div>
                            <div class="layer-name">Rain & Thunder</div>
                            <div class="layer-volume-control">
                                <input type="range" class="layer-volume-slider" 
                                       id="natureVolume" min="0" max="100" value="50">
                                <div class="volume-display" id="natureLabel">50%</div>
                            </div>
                            <button class="layer-toggle" onclick="toggleLayer('nature')">Mute</button>
                        </div>

                        <!-- Binaural Layer -->
                        <div class="layer-control" data-layer="binaural">
                            <div class="layer-icon">🎧</div>
                            <div class="layer-name">Delta Waves</div>
                            <div class="layer-volume-control">
                                <input type="range" class="layer-volume-slider" 
                                       id="binauralVolume" min="0" max="100" value="30">
                                <div class="volume-display" id="binauralLabel">30%</div>
                            </div>
                            <button class="layer-toggle" onclick="toggleLayer('binaural')">Mute</button>
                        </div>

                        <!-- Harmonic Layer -->
                        <div class="layer-control" data-layer="harmonic">
                            <div class="layer-icon">✨</div>
                            <div class="layer-name">Harmony Pad</div>
                            <div class="layer-volume-control">
                                <input type="range" class="layer-volume-slider" 
                                       id="harmonicVolume" min="0" max="100" value="40">
                                <div class="volume-display" id="harmonicLabel">40%</div>
                            </div>
                            <button class="layer-toggle" onclick="toggleLayer('harmonic')">Mute</button>
                        </div>
                    </div>

                    <!-- Timer Section -->
                    <div class="timer-section">
                        <h3 style="color: var(--secondary); margin-bottom: 15px;">⏱️ Sleep Timer</h3>
                        <div class="timer-options">
                            <button class="timer-btn" onclick="setTimer(0)">Off</button>
                            <button class="timer-btn" onclick="setTimer(15)">15m</button>
                            <button class="timer-btn" onclick="setTimer(30)">30m</button>
                            <button class="timer-btn" onclick="setTimer(60)">60m</button>
                            <button class="timer-btn" onclick="setTimer(90)">90m</button>
                        </div>
                        <div class="timer-display" id="timerDisplay">Timer Off</div>
                    </div>

                    <!-- Audio Source Info -->
                    <div class="audio-source-info">
                        Using CDN-hosted therapeutic audio files optimised for tinnitus relief
                    </div>
                </div>
            </div>

            <!-- Right Panel: Techniques -->
            <div class="techniques-panel">
                <div class="card">
                    <h2 class="card-title">🧘 Sleep Techniques</h2>
                    
                    <div class="technique-card" onclick="openTechnique('breathing')">
                        <div class="technique-title">🫁 4-7-8 Breathing</div>
                        <div class="technique-duration">Reduces anxiety in 3 minutes</div>
                    </div>

                    <div class="technique-card" onclick="openTechnique('pmr')">
                        <div class="technique-title">💪 Progressive Muscle Relaxation</div>
                        <div class="technique-duration">Full body relaxation technique</div>
                    </div>

                    <div class="technique-card" onclick="openTechnique('cognitive')">
                        <div class="technique-title">🧠 Cognitive Reframing</div>
                        <div class="technique-duration">Reduce tinnitus distress</div>
                    </div>

                    <div class="technique-card" onclick="openTechnique('protocol')">
                        <div class="technique-title">🌙 Complete Protocol</div>
                        <div class="technique-duration">Your personalised routine</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div style="text-align: center; padding: 30px 20px; color: white;">
            <p style="font-size: 1.1em; margin-bottom: 10px;">
                © 2025 Tinnitus Centres | Evidence-based relief, nationwide
            </p>
            <p style="opacity: 0.9;">
                <a href="https://www.tinnituscentres.co.uk/j/privacy" style="color: white; margin: 0 15px;">Privacy</a>
                <a href="https://www.tinnituscentres.co.uk/our-centres/" style="color: white; margin: 0 15px;">Find a Centre</a>
            </p>
        </div>
    </div>

    <!-- Email Gate Modal -->
    <div class="email-modal" id="emailModal" style="display: none;">
        <div class="email-modal-content">
            <img src="https://image.jimcdn.com/app/cms/image/transf/none/path/s960b7fc6030ac054/image/ia85c92eb1d04ab76/version/1648189187/image.png" 
                 alt="Tinnitus Centres" 
                 style="height: 40px; margin-bottom: 15px;">
            <h2 style="color: var(--secondary); margin-bottom: 20px;">🌙 Unlock Sleep Timer</h2>
            <p style="margin-bottom: 20px; color: #666;">
                Enter your email to access the sleep timer and receive your personalised sound settings
            </p>
            <input type="email" id="timerEmail" class="form-input" 
                   placeholder="your@email.com" required>
            <input type="text" id="timerName" class="form-input" 
                   placeholder="Your name (optional)" style="margin-top: 10px;">
            <div class="modal-buttons">
                <button onclick="submitTimerEmail()" class="submit-btn">
                    Unlock Timer
                </button>
                <button onclick="closeEmailModal()" class="secondary-btn">
                    Maybe Later
                </button>
            </div>
            <p style="margin-top: 15px; font-size: 12px; color: #999;">
                We'll send you your sound settings and sleep tips. No spam, ever.
            </p>
        </div>
    </div>

    <!-- Technique Video Modal -->
    <div class="email-modal" id="techniqueModal" style="display: none;">
        <div class="email-modal-content" style="max-width: 800px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="techniqueTitle" style="color: var(--secondary); margin: 0;">Technique Video</h2>
                <button onclick="closeTechniqueModal()" 
                        style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">✕</button>
            </div>
            <div id="techniqueVideoContainer"></div>
            <p id="techniqueDescription" style="margin-top: 15px; color: #666; line-height: 1.6;"></p>
        </div>
    </div>

    <script>
        // Configuration
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyYvO-neuH5egvhoCvs0ygqpc5stBegMhPQhx9eSyXZAfYtcPBfxONzc2n8Gk8p7tYW/exec';
        
        // Audio file URLs - Using your GitHub-hosted files via jsDelivr CDN
        const AUDIO_SOURCES = {
            foundation: 'https://cdn.jsdelivr.net/gh/hungryfijian/quiet-nights-audio@main/pink-noise-432hz.mp3',
            nature: 'https://cdn.jsdelivr.net/gh/hungryfijian/quiet-nights-audio@main/rain-thunder.mp3',
            binaural: 'https://cdn.jsdelivr.net/gh/hungryfijian/quiet-nights-audio@main/delta-waves-3hz.mp3',
            harmonic: 'https://cdn.jsdelivr.net/gh/hungryfijian/quiet-nights-audio@main/harmony-pad-c-major.mp3'
        };

        // Fallback to free audio sources if custom ones don't exist
        const FALLBACK_SOURCES = {
            foundation: 'https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3',
            nature: 'https://www.soundjay.com/nature/sounds/rain-03.mp3',
            binaural: 'https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3',
            harmonic: 'https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3'
        };

        // Global variables
        let audioLayers = {};
        let isPlaying = false;
        let sessionStartTime = null;
        let sessionTimer = null;
        let sleepTimer = null;
        let sleepTimerMinutes = 0;
        let fadeInterval = null;
        let timerUnlocked = false;

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            initializeAudioLayers();
            setupEventListeners();
            loadSavedPreferences();
            startSessionTimer();
            initializeVisualizer();
            
            // Check if timer was previously unlocked
            if (localStorage.getItem('timerUnlocked')) {
                timerUnlocked = true;
            }
            
            // Hide loading screen
            setTimeout(() => {
                document.getElementById('loadingScreen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('mainContainer').classList.add('loaded');
                }, 500);
            }, 1000);
        });

        // Initialize audio layers with HTML5 Audio
        function initializeAudioLayers() {
            const layers = ['foundation', 'nature', 'binaural', 'harmonic'];
            
            layers.forEach(layer => {
                const audio = new Audio();
                audio.loop = true;
                audio.volume = 0.5;
                audio.preload = 'auto';
                
                // Try primary source first
                audio.src = AUDIO_SOURCES[layer];
                
                // Handle loading errors with fallback
                audio.addEventListener('error', () => {
                    console.warn(`Failed to load ${layer} audio, trying fallback...`);
                    audio.src = FALLBACK_SOURCES[layer];
                });
                
                audioLayers[layer] = {
                    audio: audio,
                    muted: false,
                    volume: 0.5
                };
            });
        }

        // Setup all event listeners
        function setupEventListeners() {
            // Volume sliders
            ['foundation', 'nature', 'binaural', 'harmonic'].forEach(layer => {
                const slider = document.getElementById(`${layer}Volume`);
                const label = document.getElementById(`${layer}Label`);
                
                slider.addEventListener('input', () => {
                    const volume = parseInt(slider.value);
                    label.textContent = volume + '%';
                    setLayerVolume(layer, volume);
                });
            });

            // Master volume
            const masterSlider = document.getElementById('masterVolume');
            
            masterSlider.addEventListener('input', () => {
                const volume = parseInt(masterSlider.value);
                document.getElementById('masterVolumeValue').textContent = volume + '%';
                setMasterVolume(volume);
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space' && e.target.tagName !== 'INPUT') {
                    e.preventDefault();
                    togglePlayback();
                }
            });
        }

        // Toggle playback
        function togglePlayback() {
            const btn = document.getElementById('playBtn');
            const icon = document.getElementById('playIcon');
            
            if (!isPlaying) {
                // Start all audio layers
                Object.values(audioLayers).forEach(layer => {
                    if (!layer.muted) {
                        layer.audio.play().catch(error => {
                            console.error('Playback error:', error);
                            showError('Unable to start audio. Please try again.');
                        });
                    }
                });
                
                isPlaying = true;
                btn.classList.add('playing');
                icon.textContent = '⏸';
                startVisualization();
                
            } else {
                // Stop all audio layers
                Object.values(audioLayers).forEach(layer => {
                    layer.audio.pause();
                });
                
                isPlaying = false;
                btn.classList.remove('playing');
                icon.textContent = '▶';
                stopVisualization();
            }
        }

        // Toggle individual layer
        function toggleLayer(layerName) {
            const layer = audioLayers[layerName];
            const btn = event.target;
            const control = document.querySelector(`[data-layer="${layerName}"]`);
            
            if (!layer.muted) {
                // Mute layer
                layer.muted = true;
                layer.audio.pause();
                btn.textContent = 'Unmute';
                btn.classList.add('muted');
                control.classList.add('muted');
            } else {
                // Unmute layer
                layer.muted = false;
                if (isPlaying) {
                    layer.audio.play();
                }
                btn.textContent = 'Mute';
                btn.classList.remove('muted');
                control.classList.remove('muted');
            }
        }

        // Set layer volume
        function setLayerVolume(layerName, volume) {
            const normalizedVolume = volume / 100;
            if (audioLayers[layerName]) {
                audioLayers[layerName].volume = normalizedVolume;
                audioLayers[layerName].audio.volume = normalizedVolume * (parseInt(document.getElementById('masterVolume').value) / 100);
            }
        }

        // Enhanced volume control functions
        function adjustMasterVolume(change) {
            const slider = document.getElementById('masterVolume');
            const currentValue = parseInt(slider.value);
            const newValue = Math.max(0, Math.min(100, currentValue + change));
            slider.value = newValue;
            document.getElementById('masterVolumeValue').textContent = newValue + '%';
            setMasterVolume(newValue);
        }

        function setMasterVolumePreset(value) {
            const slider = document.getElementById('masterVolume');
            slider.value = value;
            document.getElementById('masterVolumeValue').textContent = value + '%';
            setMasterVolume(value);
        }

        // Set master volume
        function setMasterVolume(volume) {
            const masterMultiplier = volume / 100;
            Object.keys(audioLayers).forEach(layer => {
                audioLayers[layer].audio.volume = audioLayers[layer].volume * masterMultiplier;
            });
        }

        // Load preset configurations
        function loadPreset(preset) {
            const presets = {
                gentle: { foundation: 60, nature: 70, binaural: 20, harmonic: 50 },
                deep: { foundation: 80, nature: 40, binaural: 50, harmonic: 30 },
                active: { foundation: 50, nature: 60, binaural: 10, harmonic: 70 },
                custom: { foundation: 70, nature: 50, binaural: 30, harmonic: 40 }
            };

            const settings = presets[preset];
            Object.keys(settings).forEach(layer => {
                const slider = document.getElementById(`${layer}Volume`);
                const label = document.getElementById(`${layer}Label`);
                slider.value = settings[layer];
                label.textContent = settings[layer] + '%';
                setLayerVolume(layer, settings[layer]);
            });

            // Update active preset button
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Email gate functionality
        function setTimer(minutes) {
            if (!timerUnlocked && minutes > 0) {
                document.getElementById('emailModal').style.display = 'flex';
                return;
            }
            
            sleepTimerMinutes = minutes;
            const display = document.getElementById('timerDisplay');
            
            // Clear existing timer
            if (sleepTimer) {
                clearInterval(sleepTimer);
                sleepTimer = null;
            }
            if (fadeInterval) {
                clearInterval(fadeInterval);
                fadeInterval = null;
            }

            // Update button states
            document.querySelectorAll('.timer-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            if (minutes === 0) {
                display.textContent = 'Timer Off';
                return;
            }

            // Start countdown
            let remainingSeconds = minutes * 60;
            display.textContent = formatTime(remainingSeconds);

            sleepTimer = setInterval(() => {
                remainingSeconds--;
                display.textContent = formatTime(remainingSeconds);

                // Start fade out in last 30 seconds
                if (remainingSeconds === 30 && isPlaying) {
                    startFadeOut(30);
                }

                if (remainingSeconds <= 0) {
                    clearInterval(sleepTimer);
                    display.textContent = 'Session Complete';
                    
                    // Stop playback
                    if (isPlaying) {
                        togglePlayback();
                    }
                }
            }, 1000);
        }

        // Submit timer email
        async function submitTimerEmail() {
            const email = document.getElementById('timerEmail').value;
            if (!email) {
                alert('Please enter your email address');
                return;
            }
            
            timerUnlocked = true;
            localStorage.setItem('timerUnlocked', 'true');
            localStorage.setItem('userEmail', email);
            
            const name = document.getElementById('timerName').value;
            
            // Collect session data
            const sessionData = {
                timestamp: new Date().toISOString(),
                email: email,
                name: name || 'Sleep Timer User',
                timerUnlocked: true,
                soundMix: {
                    foundation: document.getElementById('foundationVolume').value,
                    nature: document.getElementById('natureVolume').value,
                    binaural: document.getElementById('binauralVolume').value,
                    harmonic: document.getElementById('harmonicVolume').value,
                },
                referrer: document.referrer,
                userAgent: navigator.userAgent
            };
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(sessionData)
                });
                
                closeEmailModal();
                alert('Timer unlocked! You can now use all timer features.');
                
            } catch (error) {
                console.error('Error submitting email:', error);
                closeEmailModal();
                alert('Timer unlocked! You can now use all timer features.');
            }
        }

        function closeEmailModal() {
            document.getElementById('emailModal').style.display = 'none';
        }

        // Smooth fade out
        function startFadeOut(seconds) {
            const steps = seconds * 10; // 10 steps per second
            const currentMaster = parseInt(document.getElementById('masterVolume').value);
            const decrement = currentMaster / steps;
            let currentVolume = currentMaster;

            fadeInterval = setInterval(() => {
                currentVolume -= decrement;
                if (currentVolume <= 0) {
                    currentVolume = 0;
                    clearInterval(fadeInterval);
                }
                document.getElementById('masterVolume').value = currentVolume;
                document.getElementById('masterVolumeValue').textContent = Math.round(currentVolume) + '%';
                setMasterVolume(currentVolume);
            }, 100);
        }

        // Initialize visualizer
        function initializeVisualizer() {
            const visualizer = document.getElementById('visualizer');
            for (let i = 0; i < 40; i++) {
                const bar = document.createElement('div');
                bar.className = 'visualizer-bar';
                bar.style.height = '10px';
                visualizer.appendChild(bar);
            }
        }

        // Visualization animation
        let visualizationFrame;
        function startVisualization() {
            const bars = document.querySelectorAll('.visualizer-bar');
            
            function animate() {
                bars.forEach((bar, i) => {
                    // Simple random visualization
                    const height = Math.random() * 60 + 10;
                    bar.style.height = height + 'px';
                });
                visualizationFrame = requestAnimationFrame(animate);
            }
            
            animate();
        }

        function stopVisualization() {
            cancelAnimationFrame(visualizationFrame);
            document.querySelectorAll('.visualizer-bar').forEach(bar => {
                bar.style.height = '10px';
            });
        }

        // Format time display
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Start session timer
        function startSessionTimer() {
            sessionStartTime = Date.now();
            updateSessionTime();
            sessionTimer = setInterval(updateSessionTime, 1000);
        }

        function updateSessionTime() {
            const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
            document.getElementById('sessionTime').textContent = formatTime(elapsed);
        }

        // Load saved preferences
        function loadSavedPreferences() {
            // Load previously saved email if exists
            const savedEmail = localStorage.getItem('userEmail');
            if (savedEmail && document.getElementById('timerEmail')) {
                document.getElementById('timerEmail').value = savedEmail;
            }
        }

        // Open technique (with video support)
        function openTechnique(technique) {
            const techniques = {
                breathing: {
                    title: '🫁 4-7-8 Breathing Technique',
                    videoId: 'R3bP0KOPI4Y',
                    description: 'The 4-7-8 breathing technique is a powerful relaxation method that activates your parasympathetic nervous system. Breathe in for 4 counts, hold for 7 counts, and breathe out for 8 counts. This pattern helps calm your mind and prepare your body for sleep. Practice this technique 2-3 times before bed for best results.'
                },
                pmr: {
                    title: '💪 Progressive Muscle Relaxation',
                    videoId: null, // Add video ID when available
                    description: 'Progressive Muscle Relaxation involves systematically tensing and releasing each muscle group in your body. Start from your toes and work your way up to your head. This technique helps release physical tension that may be preventing sleep and is particularly effective for those who carry stress in their bodies.'
                },
                cognitive: {
                    title: '🧠 Cognitive Reframing for Tinnitus',
                    videoId: null, // Add video ID when available
                    description: 'Cognitive Reframing helps you change how you think about and respond to your tinnitus. Instead of fighting the sound, learn to acknowledge it without emotional reaction. This technique involves noticing thoughts about your tinnitus and gently redirecting focus to the pleasant aspects of your chosen therapeutic sounds.'
                },
                protocol: {
                    title: '🌙 Complete Sleep Protocol',
                    videoId: null, // Add video ID when available
                    description: 'The Complete Protocol combines all techniques in an optimal sequence: Start with 4-7-8 breathing to calm your nervous system, follow with progressive muscle relaxation to release physical tension, and finish with cognitive reframing to manage any tinnitus-related anxiety. This comprehensive approach addresses all aspects of sleep preparation.'
                }
            };
            
            const tech = techniques[technique];
            
            if (tech.videoId) {
                // Open modal with video
                document.getElementById('techniqueModal').style.display = 'flex';
                document.getElementById('techniqueTitle').textContent = tech.title;
                document.getElementById('techniqueDescription').textContent = tech.description;
                
                // Embed YouTube video
                const videoContainer = document.getElementById('techniqueVideoContainer');
                videoContainer.innerHTML = `
                    <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
                        <iframe src="https://www.youtube.com/embed/${tech.videoId}" 
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;"
                                title="${tech.title}"
                                frameborder="0" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                                allowfullscreen>
                        </iframe>
                    </div>
                `;
            } else {
                // Show alert for techniques without videos yet
                alert(`${tech.title}\n\n${tech.description}\n\nVideo guide coming soon!`);
            }
        }

        function closeTechniqueModal() {
            document.getElementById('techniqueModal').style.display = 'none';
            // Clear video to stop playback
            document.getElementById('techniqueVideoContainer').innerHTML = '';
        }

        // Show error message
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            setTimeout(() => {
                errorEl.classList.remove('show');
            }, 5000);
        }

        // Handle page visibility changes (pause when tab is hidden)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && isPlaying) {
                // Optional: pause when tab is hidden
                // togglePlayback();
            }
        });
    </script>
</body>
</html>